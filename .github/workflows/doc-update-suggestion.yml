name: Documentation Update Suggestion

on:
  workflow_call:
    inputs:
      target_docs:
        description: 'Target documentation files to check (comma-separated)'
        type: string
        default: 'README.md,CHANGELOG.md,CLAUDE.md'
      timeout_minutes:
        description: 'Workflow timeout in minutes'
        type: number
        default: 10
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        description: 'Claude Code OAuth token for authentication'
        required: true

jobs:
  suggest-doc-updates:
    if: github.event.pull_request.user.login != 'github-actions[bot]'

    runs-on: ubuntu-24.04
    timeout-minutes: ${{ inputs.timeout_minutes }}

    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Suggest Documentation Updates
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Read,Glob,Grep"'
          prompt: |
            Analyze PR #${{ github.event.pull_request.number }} in ${{ github.repository }}.
            Title: ${{ github.event.pull_request.title }}

            Check if documentation updates are needed for: ${{ inputs.target_docs }}

            Steps:
            1. Run: gh pr diff ${{ github.event.pull_request.number }}
            2. Identify ALL changes (new features, breaking changes, bug fixes, API changes)
            3. For EACH target doc file, check if updates are needed:
               - CHANGELOG.md: New features, fixes, breaking changes
               - README.md: User-facing changes, new requirements, usage changes
               - CLAUDE.md: Architecture changes, service descriptions, patterns
            4. Read each target doc file to check current content accuracy

            IMPORTANT: List ALL documentation updates needed in a SINGLE comment.
            Do not prioritize - report everything that needs updating at once.

            If updates needed, post ONE comprehensive comment using:
            gh pr comment ${{ github.event.pull_request.number }} --body "..."

            Format the comment with sections for each file that needs updates.
            Mark files that don't need updates as "âœ… No changes needed".

            If no updates needed for any file, exit silently.
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
